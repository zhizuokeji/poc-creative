# 步骤7：配图执行阶段 - 程序自动化图片处理

## 处理方式

**重要说明**：此阶段由程序自动化执行，不需要大模型参与。程序将根据配图计划阶段的JSON输出，自动完成图片搜索、下载、保存和路径更新等工作。

## 程序执行目标

程序自动处理包含配图描述的文章JSON数据，调用图像生成器API搜索/生成符合要求的图片，将图片保存为独立文件，并自动更新JSON数据中每个章节的imagePath字段。

## 程序输入格式

程序接收配图计划阶段生成的JSON格式文章数据，其中sections数组的每个章节包含imageDescription字段：

```json
{
   "title": "文章标题",
   "description": "文章简介",
   "metadata": {
      ...
   },
   "sections": [
      {
         "title": "章节标题",
         "content": "章节内容...",
         "imageDescription": "展示AI技术融入生活各个场景的概念图，包含智能手机、智能家居、自动驾驶等元素，采用扁平化设计风格，蓝色渐变背景",
         "level": 2,
         "order": 1
      }
   ]
}
```

## 程序执行步骤

1. **解析配图需求**：
   - 程序遍历输入JSON中sections数组
   - 识别包含imageDescription字段的章节
   - 提取每个章节的配图描述信息

2. **构建搜索查询**：
   - 程序分析imageDescription内容
   - 提取关键词构建适合图像搜索的查询词
   - 根据描述中的风格要求设置搜索参数

3. **调用图像服务**：
   - 程序使用Pixabay API或其他图像服务搜索符合要求的图片
   - 根据搜索结果选择最合适的图片
   - 处理API调用失败和重试逻辑

4. **下载图片文件**：
   - 程序将选中的图片下载到本地images目录
   - 使用有意义的文件名（如：hero-image.jpg, section1-image.jpg）
   - 确保图片文件路径使用相对于markdown文件的相对路径
   - 处理下载失败和文件保存错误

5. **更新JSON数据**：
   - 程序为每个章节的imagePath字段填入正确的图片相对路径
   - 验证图片文件是否成功保存
   - 确保JSON数据结构的完整性

## 程序输出格式

程序自动生成更新后的JSON数据，包含每个章节的imagePath字段：

```json
{
   "title": "文章标题",
   "description": "文章简介",
   "metadata": {
      ...
   },
   "sections": [
      {
         "title": "章节标题",
         "content": "章节内容...",
         "imageDescription": "展示AI技术融入生活各个场景的概念图",
         "imagePath": "images/hero-image.jpg",
         "level": 2,
         "order": 1
      }
   ]
}
```

### 图片文件处理规范

- **独立文件保存**：程序将获取的图片保存为独立的文件，不嵌入到其他格式中
- **文件命名规范**：程序使用有意义的名称，如hero-image.jpg、section1-image.jpg等
- **相对路径**：程序确保所有图片文件路径使用相对于markdown文件的相对路径
- **路径关联**：程序确保JSON中的imagePath字段与实际保存的图片文件路径一致

### 测试代码处理要求

- **YAML序列化**：程序执行结果需序列化为YAML格式保存，便于人类作者检查
- **图片验证**：测试代码验证图片文件是否成功保存，验证JSON中的图片路径是否正确
- **人工检查**：支持人类作者检查图片选择是否合适，路径是否正确
- **错误处理**：完善的错误处理和日志记录，便于调试和问题排查

### 程序实现要求

- **API集成**：集成Pixabay API或其他图像服务的调用
- **错误重试**：实现API调用失败的重试机制
- **文件管理**：自动创建images目录，处理文件命名冲突
- **日志记录**：记录图片搜索、下载、保存的详细日志

## 程序实现指导

### 1. 图像搜索策略

- **关键词提取**：程序从imageDescription中提取关键词，构建搜索查询
- **搜索参数**：根据描述中的风格要求设置image_type（photo/illustration/vector）
- **结果筛选**：程序自动选择分辨率适中、质量较高的图片

### 2. 版权和内容合规

- **版权安全**：优先使用Pixabay等明确授权的图像服务，确保版权安全
- **内容审核**：程序应过滤不合适的图片内容，确保符合发布要求
- **风格一致性**：程序尽量保持全文配图风格的统一性

### 3. 错误处理机制

- **API失败**：实现API调用失败的重试机制，记录失败原因
- **下载失败**：处理图片下载失败的情况，提供备选方案
- **文件冲突**：处理文件名冲突，自动生成唯一文件名
- **占位符**：如果图片获取失败，在imagePath中使用占位符并记录日志

### 4. 质量保证

- **图片验证**：验证下载的图片文件完整性和格式正确性
- **路径验证**：确保生成的相对路径在markdown文件中能正确引用
- **大小优化**：适当压缩图片大小，平衡质量和加载速度
- **格式统一**：统一图片格式（建议使用jpg或png）

### 5. 日志和监控

- **详细日志**：记录每个图片的搜索、选择、下载过程
- **性能监控**：监控API调用时间和成功率
- **错误统计**：统计各类错误的发生频率，便于优化
- **人工审核**：提供机制让人类作者审核和替换不合适的图片
